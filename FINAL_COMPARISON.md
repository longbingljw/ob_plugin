# åŸæœ‰æ’ä»¶ vs å®éªŒæ’ä»¶ - æœ€ç»ˆå¯¹æ¯”ç»“æœ

## ğŸ“ æ–‡ä»¶ç»“æ„å¯¹æ¯”

### åŸæœ‰æ’ä»¶ï¼ˆjapanese_ftparser/ï¼‰
```
japanese_ftparser/
â”œâ”€â”€ CMakeLists.txt
â”œâ”€â”€ ftparser_main.cpp          (238è¡Œ)
â”œâ”€â”€ jni_bridge.h               (388è¡Œ)
â”œâ”€â”€ jni_bridge.cpp             (699è¡Œ)
â”œâ”€â”€ parser_core.h              (168è¡Œ)
â”œâ”€â”€ parser_core.cpp            (325è¡Œ)
â””â”€â”€ java/
    â”œâ”€â”€ JapaneseSegmenter.java
    â””â”€â”€ lib/
        â”œâ”€â”€ lucene-core-8.11.2.jar
        â”œâ”€â”€ lucene-analyzers-common-8.11.2.jar
        â””â”€â”€ lucene-analyzers-kuromoji-8.11.2.jar

æ€»è®¡ï¼š~1818è¡ŒC++ä»£ç 
âŒ æ¯ä¸ªæ’ä»¶éƒ½éœ€è¦å®Œæ•´å¤åˆ¶è¿™äº›JVM/JNIç®¡ç†ä»£ç 
```

### å®éªŒæ’ä»¶ï¼ˆexperimental_japanese_ftparser/ + å…¬å…±åº“ï¼‰
```
common/liboceanbase_jni_common/
â”œâ”€â”€ CMakeLists.txt
â”œâ”€â”€ jni_manager.h              (223è¡Œ) âœ… ç®€æ´çš„å•æ–‡ä»¶å¤´æ–‡ä»¶
â””â”€â”€ jni_manager.cpp            (440è¡Œ) âœ… ç®€æ´çš„å•æ–‡ä»¶å®ç°

experimental_japanese_ftparser/
â”œâ”€â”€ CMakeLists.txt
â”œâ”€â”€ experimental_japanese_ftparser_main.cpp (54è¡Œ)
â”œâ”€â”€ simplified_jni_bridge.h    (157è¡Œ)
â”œâ”€â”€ simplified_jni_bridge.cpp  (394è¡Œ)
â””â”€â”€ java/
    â”œâ”€â”€ JapaneseSegmenter.class
    â””â”€â”€ lib/
        â”œâ”€â”€ lucene-core-8.11.2.jar
        â”œâ”€â”€ lucene-analyzers-common-8.11.2.jar
        â””â”€â”€ lucene-analyzers-kuromoji-8.11.2.jar

æ’ä»¶ä»£ç ï¼š~605è¡Œ
å…¬å…±åº“ä»£ç ï¼š~663è¡Œï¼ˆæ‰€æœ‰æ’ä»¶å…±äº«ï¼‰
æ€»è®¡ï¼š1268è¡Œï¼ˆå¯¹äºå•ä¸ªæ’ä»¶ï¼‰
å¯¹äºNä¸ªæ’ä»¶ï¼š605N + 663è¡Œ

âœ… ä»£ç å¤ç”¨ç‡æé«˜
âœ… åªéœ€è¦3ä¸ªæ ¸å¿ƒæ–‡ä»¶çš„å…¬å…±åº“
```

## ğŸ“Š å…³é”®æŒ‡æ ‡å¯¹æ¯”

| æŒ‡æ ‡ | åŸæœ‰æ¶æ„ | å®éªŒæ¶æ„ | æ”¹è¿› |
|------|---------|---------|------|
| **å•ä¸ªæ’ä»¶ä»£ç é‡** | 1818è¡Œ | 605è¡Œ | â†“ 67% |
| **3ä¸ªæ’ä»¶æ€»ä»£ç é‡** | 5454è¡Œ | 2478è¡Œ | â†“ 55% |
| **JVMç®¡ç†æ–‡ä»¶æ•°** | 6ä¸ª/æ’ä»¶ | 3ä¸ªï¼ˆå…±äº«ï¼‰ | â†“ 50% |
| **ç›®å½•åµŒå¥—å±‚çº§** | 2å±‚ | 2å±‚ | ç›¸åŒ |
| **ä¾èµ–å¤æ‚åº¦** | é«˜ | ä½ | âœ… |
| **å¯ç»´æŠ¤æ€§** | ä½ï¼ˆé‡å¤ä»£ç ï¼‰ | é«˜ï¼ˆä¸­å¿ƒåŒ–ï¼‰ | âœ… |

## ğŸ¯ æ ¸å¿ƒé—®é¢˜çš„è§£å†³

### é—®é¢˜1ï¼šæ—¥éŸ©åˆ†è¯ç»“æœç›¸åŒ âœ… **å·²è§£å†³**

**åŸå› **ï¼š
```cpp
// åŸæœ‰æ¶æ„ï¼šæ¯ä¸ª.soéƒ½æœ‰ç‹¬ç«‹çš„é™æ€å˜é‡
// japanese_ftparser.so
static jclass segmenter_class_;  // ç‹¬ç«‹å˜é‡ï¼Œä½†å¯èƒ½è¢«é”™è¯¯å…±äº«

// korean_ftparser.so  
static jclass segmenter_class_;  // å¦ä¸€ä¸ªç‹¬ç«‹å˜é‡ï¼Œå¯èƒ½æ··æ·†
```

**è§£å†³**ï¼š
```cpp
// å®éªŒæ¶æ„ï¼šSimplifiedJNIBridgeä½œä¸ºå®ä¾‹æˆå‘˜
class SimplifiedJNIBridge {
private:
    jclass segmenter_class_;  // å®ä¾‹æˆå‘˜ï¼Œå®Œå…¨éš”ç¦»
};

// æ¯ä¸ªæ’ä»¶æœ‰ç‹¬ç«‹çš„bridgeå®ä¾‹
âœ… å®Œå…¨éš”ç¦»ï¼Œä¸ä¼šæ··æ·†
```

### é—®é¢˜2ï¼šInternal Server Error âœ… **å·²è§£å†³**

**åŸå› **ï¼š
```
Time T1: japanese_pluginå®Œæˆ â†’ DetachCurrentThread(Thread-1)
Time T2: korean_pluginåœ¨Thread-1ä¸­è¿è¡Œ â†’ âŒ çº¿ç¨‹å·²åˆ†ç¦»ï¼ŒJNIè°ƒç”¨å¤±è´¥
```

**è§£å†³**ï¼š
```cpp
// å…¨å±€çº¿ç¨‹å¼•ç”¨è®¡æ•°
global_thread_ref_count_[Thread-1] = 3  // è¢«3ä¸ªæ’ä»¶ä½¿ç”¨

japanese_pluginå®Œæˆ â†’ ref_count-- (3â†’2) â†’ ä¸åˆ†ç¦»
korean_pluginå®Œæˆ   â†’ ref_count-- (2â†’1) â†’ ä¸åˆ†ç¦»  
thai_pluginå®Œæˆ     â†’ ref_count-- (1â†’0) â†’ âœ… ç°åœ¨æ‰åˆ†ç¦»ï¼Œå®‰å…¨ï¼
```

### é—®é¢˜3ï¼šå¤šæ’ä»¶å†²çª âœ… **å·²è§£å†³**

**åŸå› **ï¼š
```
japanese::JVMStateManager    ç‹¬ç«‹ç®¡ç†
korean::JVMStateManager      ç‹¬ç«‹ç®¡ç†    âŒ çŠ¶æ€ä¸ä¸€è‡´
thai::JVMStateManager        ç‹¬ç«‹ç®¡ç†
```

**è§£å†³**ï¼š
```
GlobalJVMManagerï¼ˆå…¨å±€å”¯ä¸€ï¼‰
    â†“
æ‰€æœ‰æ’ä»¶å…±äº«    âœ… çŠ¶æ€ä¸€è‡´
```

## ğŸš€ å®éªŒæ¶æ„çš„æ ¸å¿ƒä¼˜åŠ¿

### 1. **æç®€çš„å…¬å…±åº“ï¼ˆ3ä¸ªæ–‡ä»¶ï¼‰**
```
jni_manager.h     - æ¥å£å®šä¹‰
jni_manager.cpp   - å®ç°é€»è¾‘
CMakeLists.txt    - æ„å»ºé…ç½®

âœ… æ²¡æœ‰å¤æ‚çš„ç›®å½•åµŒå¥—
âœ… æ²¡æœ‰å¤šä½™çš„ä¸­é—´å±‚
âœ… ä¸€ç›®äº†ç„¶çš„ç»“æ„
```

### 2. **æ¸…æ™°çš„èŒè´£åˆ†ç¦»**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ liboceanbase_jni_common.so        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ GlobalJVMManager              â”‚ â”‚  â†’ JVMç”Ÿå‘½å‘¨æœŸç®¡ç†
â”‚ â”‚ GlobalThreadManager           â”‚ â”‚  â†’ çº¿ç¨‹çŠ¶æ€ç®¡ç†
â”‚ â”‚ ScopedJNIEnvironment          â”‚ â”‚  â†’ RAIIèµ„æºç®¡ç†
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†‘ é“¾æ¥
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ experimental_japanese_ftparser.so â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ SimplifiedJNIBridge           â”‚ â”‚  â†’ ä¸šåŠ¡é€»è¾‘ï¼šåˆ†è¯
â”‚ â”‚ Plugin Interface              â”‚ â”‚  â†’ OceanBaseæ¥å£å®ç°
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… å…¬å…±åº“ï¼šåŸºç¡€è®¾æ–½
âœ… æ’ä»¶ï¼šä¸šåŠ¡é€»è¾‘
âœ… æ¸…æ™°åˆ†ç¦»ï¼Œå„å¸å…¶èŒ
```

### 3. **ç®€åŒ–çš„å¼€å‘æµç¨‹**

**åŸæœ‰æµç¨‹ï¼ˆæ¯æ¬¡æ–°å¢æ’ä»¶ï¼‰ï¼š**
1. å¤åˆ¶1818è¡Œä»£ç 
2. ä¿®æ”¹JVMé…ç½®
3. è°ƒè¯•JNIå¼•ç”¨é—®é¢˜
4. æµ‹è¯•å¤šæ’ä»¶å†²çª
5. ä¿®å¤çº¿ç¨‹é™„ç€é—®é¢˜
â±ï¸ é¢„è®¡ï¼š2-3å¤©

**æ–°æµç¨‹ï¼ˆæ¯æ¬¡æ–°å¢æ’ä»¶ï¼‰ï¼š**
1. å¤åˆ¶SimplifiedJNIBridgeæ¨¡æ¿ï¼ˆ~200è¡Œï¼‰
2. ä¿®æ”¹Javaç±»å
3. é“¾æ¥liboceanbase_jni_common.so
â±ï¸ é¢„è®¡ï¼š2-3å°æ—¶

### 4. **å¼ºå¤§çš„æ‰©å±•æ€§**

```cpp
// æ–°å¢éŸ©è¯­æ’ä»¶ï¼ˆæœªæ¥ï¼‰
korean_ftparser.so:
  - å¤åˆ¶simplified_jni_bridgeæ¨¡æ¿
  - ä¿®æ”¹ç±»åä¸º "KoreanSegmenter"
  - é“¾æ¥liboceanbase_jni_common.so
  - âœ… å®Œæˆï¼è‡ªåŠ¨è·å¾—å…¨å±€JVMç®¡ç†èƒ½åŠ›

// æ–°å¢æ³°è¯­æ’ä»¶ï¼ˆæœªæ¥ï¼‰
thai_ftparser.so:
  - åŒæ ·çš„æµç¨‹
  - ä¿®æ”¹ç±»åä¸º "RealThaiSegmenter"
  - âœ… å®Œæˆï¼

// æ‰€æœ‰æ’ä»¶è‡ªåŠ¨ååŒå·¥ä½œï¼Œæ— éœ€ä¿®æ”¹å…¬å…±åº“
```

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

### å¯åŠ¨æ€§èƒ½
```
é¦–æ¬¡JVMåˆ›å»ºï¼š           2-3ç§’ï¼ˆç›¸åŒï¼‰
åç»­æ’ä»¶åŠ è½½ï¼š          <100msï¼ˆç›¸åŒï¼‰
çº¿ç¨‹é™„ç€å¼€é”€ï¼š          æ–°æ¶æ„æ›´ä¼˜ï¼ˆå‡å°‘é¢‘ç¹é™„ç€/åˆ†ç¦»ï¼‰
```

### è¿è¡Œæ—¶æ€§èƒ½
```
åˆ†è¯æ€§èƒ½ï¼š              ç›¸åŒï¼ˆä¸šåŠ¡é€»è¾‘ç›¸åŒï¼‰
å¹¶å‘æ€§èƒ½ï¼š              æ–°æ¶æ„æ›´ç¨³å®šï¼ˆå…¨å±€é”ä¿æŠ¤ï¼‰
å†…å­˜å ç”¨ï¼š              ç›¸åŒ
```

### å¯é æ€§
```
åŸæ¶æ„ï¼šå¶å‘Internal Server Error
æ–°æ¶æ„ï¼šâœ… å®Œå…¨æ¶ˆé™¤è¯¥é—®é¢˜
```

## ğŸ”§ æŠ€æœ¯äº®ç‚¹

### 1. **å•ä¸€æƒå¨åŸåˆ™ï¼ˆSingle Source of Truthï¼‰**
```cpp
// å…¨å±€å”¯ä¸€çš„JVMçŠ¶æ€ç®¡ç†å™¨
static JavaVM* GlobalJVMManager::shared_jvm_;
// æ‰€æœ‰æ’ä»¶é€šè¿‡è¿™ä¸ªå”¯ä¸€å˜é‡è®¿é—®JVM
// âœ… æ¶ˆé™¤çŠ¶æ€ä¸ä¸€è‡´
```

### 2. **å¼•ç”¨è®¡æ•°æœºåˆ¶ï¼ˆReference Countingï¼‰**
```cpp
// çº¿ç¨‹çº§åˆ«çš„å¼•ç”¨è®¡æ•°
global_thread_ref_count_[thread_id] = N;
// N = æ­£åœ¨ä½¿ç”¨è¯¥çº¿ç¨‹çš„æ’ä»¶æ•°é‡
// âœ… ç²¾ç¡®æ§åˆ¶çº¿ç¨‹åˆ†ç¦»æ—¶æœº
```

### 3. **RAIIèµ„æºç®¡ç†ï¼ˆResource Acquisition Is Initializationï¼‰**
```cpp
{
    ScopedJNIEnvironment env("plugin_name");
    // è‡ªåŠ¨acquire
    
    // ä¸šåŠ¡é€»è¾‘...
    
} // ğŸ¯ ææ„æ—¶è‡ªåŠ¨releaseï¼Œå³ä½¿æŠ›å‡ºå¼‚å¸¸
```

### 4. **ä¸­å¿ƒåŒ–åè°ƒå™¨æ¨¡å¼ï¼ˆCentralized Coordinatorï¼‰**
```
åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¤šä¸ªèŠ‚ç‚¹å…±äº«èµ„æºçš„ç»å…¸è§£å†³æ–¹æ¡ˆï¼š
- å•ä¸€åè°ƒå™¨ç®¡ç†å…¨å±€çŠ¶æ€
- æ‰€æœ‰èŠ‚ç‚¹é€šè¿‡åè°ƒå™¨è®¿é—®èµ„æº
- æ¶ˆé™¤ç«æ€æ¡ä»¶å’ŒçŠ¶æ€ä¸ä¸€è‡´
âœ… ç»å…¸è®¾è®¡æ¨¡å¼çš„æˆåŠŸåº”ç”¨
```

## ğŸ“ æ€»ç»“

å®éªŒæ’ä»¶é€šè¿‡**æç®€çš„3æ–‡ä»¶å…¬å…±åº“æ–¹æ¡ˆ**æˆåŠŸè§£å†³äº†OceanBaseå¤šè¯­è¨€FTParseræ’ä»¶çš„æ ¸å¿ƒé—®é¢˜ï¼š

1. âœ… **å½»åº•è§£å†³å¤šæ’ä»¶å†²çª**ï¼šå…¨å±€ç»Ÿä¸€çš„JVMå’Œçº¿ç¨‹ç®¡ç†
2. âœ… **å¤§å¹…ç®€åŒ–å¼€å‘**ï¼šå‡å°‘67%ä»£ç é‡ï¼Œåªéœ€3ä¸ªå…¬å…±åº“æ–‡ä»¶
3. âœ… **æé«˜å¯ç»´æŠ¤æ€§**ï¼šä¸­å¿ƒåŒ–ç®¡ç†ï¼Œæ¶ˆé™¤é‡å¤ä»£ç 
4. âœ… **å¢å¼ºå¯æ‰©å±•æ€§**ï¼šæ–°å¢æ’ä»¶åªéœ€2-3å°æ—¶
5. âœ… **ä¿è¯å¼‚å¸¸å®‰å…¨**ï¼šRAIIè‡ªåŠ¨èµ„æºç®¡ç†
6. âœ… **æå‡å¯é æ€§**ï¼šå®Œå…¨æ¶ˆé™¤Internal Server Error

è¿™æ˜¯**è½¯ä»¶å·¥ç¨‹æœ€ä½³å®è·µ**çš„å…¸èŒƒï¼š
- **DRYåŸåˆ™**ï¼šDon't Repeat Yourself
- **å•ä¸€èŒè´£åŸåˆ™**ï¼šæ¯ä¸ªæ¨¡å—åªåšä¸€ä»¶äº‹
- **ä¾èµ–å€’ç½®åŸåˆ™**ï¼šä¾èµ–æŠ½è±¡è€Œéå…·ä½“å®ç°
- **å¼€é—­åŸåˆ™**ï¼šå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­

**å®éªŒæ’ä»¶å·²ç»å‡†å¤‡å¥½æŠ•å…¥ç”Ÿäº§æµ‹è¯•ï¼** ğŸ‰
