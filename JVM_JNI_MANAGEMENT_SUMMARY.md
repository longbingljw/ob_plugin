# å®éªŒæ’ä»¶ JVM å’Œ JNI ç®¡ç†é€»è¾‘æ€»ç»“

## ğŸ¯ æ ¸å¿ƒè®¾è®¡æ€æƒ³

å®éªŒæ’ä»¶é‡‡ç”¨**å…¬å…±åº“æ–¹æ¡ˆ**ï¼Œé€šè¿‡`liboceanbase_jni_common.so`æä¾›ç»Ÿä¸€çš„JVMå’ŒJNIèµ„æºç®¡ç†ï¼Œå½»åº•è§£å†³äº†å¤šæ’ä»¶ç¯å¢ƒä¸‹çš„èµ„æºå†²çªé—®é¢˜ã€‚

## ğŸ“¦ æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             liboceanbase_jni_common.so (å…¬å…±åº“)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  GlobalJVMManager                                      â”‚  â”‚
â”‚  â”‚  - ç®¡ç†å…¨å±€å”¯ä¸€çš„JVMå®ä¾‹                               â”‚  â”‚
â”‚  â”‚  - è·Ÿè¸ªæ‰€æœ‰æ³¨å†Œçš„æ’ä»¶                                   â”‚  â”‚
â”‚  â”‚  - éªŒè¯JVMé…ç½®ä¸€è‡´æ€§                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  GlobalThreadManager                                   â”‚  â”‚
â”‚  â”‚  - ç®¡ç†æ¯ä¸ªçº¿ç¨‹çš„JNIç¯å¢ƒ                               â”‚  â”‚
â”‚  â”‚  - å…¨å±€çº¿ç¨‹å¼•ç”¨è®¡æ•°                                    â”‚  â”‚
â”‚  â”‚  - è·Ÿè¸ªçº¿ç¨‹-æ’ä»¶æ˜ å°„å…³ç³»                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ScopedJNIEnvironment (RAIIå°è£…)                      â”‚  â”‚
â”‚  â”‚  - è‡ªåŠ¨è·å–/é‡Šæ”¾JNIç¯å¢ƒ                                â”‚  â”‚
â”‚  â”‚  - å¼‚å¸¸å®‰å…¨çš„èµ„æºç®¡ç†                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†‘ é“¾æ¥ ($ORIGINæŸ¥æ‰¾)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     experimental_japanese_ftparser.so (æ’ä»¶)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  SimplifiedJNIBridge                                   â”‚  â”‚
â”‚  â”‚  - ä½¿ç”¨ScopedJNIEnvironmentè·å–JNIç¯å¢ƒ                 â”‚  â”‚
â”‚  â”‚  - è°ƒç”¨Javaåˆ†è¯æ–¹æ³•                                    â”‚  â”‚
â”‚  â”‚  - å¤„ç†ä¸šåŠ¡é€»è¾‘                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. GlobalJVMManager - JVMç”Ÿå‘½å‘¨æœŸç®¡ç†

**èŒè´£**ï¼š
- åˆ›å»ºæˆ–è·å–å…¨å±€å”¯ä¸€çš„JVMå®ä¾‹
- ç®¡ç†æ’ä»¶æ³¨å†Œ/æ³¨é”€
- éªŒè¯JVMé…ç½®ä¸€è‡´æ€§
- å®‰å…¨åœ°é”€æ¯JVMï¼ˆä»…åœ¨æ‰€æœ‰æ’ä»¶å¸è½½åï¼‰

**å…³é”®æ•°æ®ç»“æ„**ï¼š
```cpp
class GlobalJVMManager {
private:
    static std::mutex global_mutex_;                    // å…¨å±€é”ï¼Œä¿æŠ¤æ‰€æœ‰æ“ä½œ
    static JavaVM* shared_jvm_;                         // å…¨å±€å”¯ä¸€çš„JVMæŒ‡é’ˆ
    static std::atomic<int> plugin_count_;              // å½“å‰æ³¨å†Œçš„æ’ä»¶æ•°é‡
    static std::unordered_set<std::string> registered_plugins_;  // å·²æ³¨å†Œæ’ä»¶é›†åˆ
    
    // é¦–æ¬¡åˆ›å»ºJVMæ—¶çš„é…ç½®
    static std::string first_instance_classpath_;
    static size_t first_instance_max_heap_mb_;
    static size_t first_instance_init_heap_mb_;
};
```

**å·¥ä½œæµç¨‹**ï¼š

#### 1.1 JVMåˆ›å»º/è·å–æµç¨‹

```
æ’ä»¶Aé¦–æ¬¡è°ƒç”¨ get_or_create_jvm()
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. åŠ å…¨å±€é” (global_mutex_)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. æ£€æŸ¥ shared_jvm_ æ˜¯å¦å·²å­˜åœ¨      â”‚
â”‚    - å¦‚æœå­˜åœ¨ â†’ ç›´æ¥è¿”å›            â”‚
â”‚    - å¦‚æœä¸å­˜åœ¨ â†’ ç»§ç»­              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. å°è¯•è·å–è¿›ç¨‹ä¸­å·²æœ‰çš„JVM          â”‚
â”‚    JNI_GetCreatedJavaVMs()          â”‚
â”‚    - å¦‚æœæ‰¾åˆ° â†’ æ ‡è®°ä¸ºå¤–éƒ¨JVMï¼Œè¿”å› â”‚
â”‚    - å¦‚æœæ²¡æœ‰ â†’ ç»§ç»­                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. åˆ›å»ºæ–°JVM                        â”‚
â”‚    å‡†å¤‡å‚æ•°ï¼š                       â”‚
â”‚    - classpath                      â”‚
â”‚    - Xmx (æœ€å¤§å †)                   â”‚
â”‚    - Xms (åˆå§‹å †)                   â”‚
â”‚    - UseG1GC                        â”‚
â”‚    - file.encoding=UTF-8            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. JNI_CreateJavaVM(&shared_jvm_,   â”‚
â”‚                     &env, &vm_args) â”‚
â”‚    - æˆåŠŸ â†’ shared_jvm_ æŒ‡å‘æ–°JVM   â”‚
â”‚    - å¤±è´¥ â†’ è¿”å› nullptr            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. è®°å½•é¦–æ¬¡é…ç½®                     â”‚
â”‚    first_instance_classpath_ = ...  â”‚
â”‚    config_recorded_ = true          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
è¿”å› shared_jvm_

æ’ä»¶Båç»­è°ƒç”¨ get_or_create_jvm()
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. åŠ å…¨å±€é”                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. shared_jvm_ å·²å­˜åœ¨               â”‚
â”‚    éªŒè¯é…ç½®ä¸€è‡´æ€§ï¼š                 â”‚
â”‚    - classpathæ˜¯å¦ç›¸åŒ              â”‚
â”‚    - å †å¤§å°æ˜¯å¦ç›¸åŒ                 â”‚
â”‚    - ä¸ä¸€è‡´ â†’ è®°å½•WARNING           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
è¿”å› shared_jvm_ (å¤ç”¨å·²æœ‰JVM)
```

#### 1.2 æ’ä»¶æ³¨å†Œ/æ³¨é”€æµç¨‹

```
register_plugin("plugin_name")
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. åŠ å…¨å±€é”                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. registered_plugins_.insert()     â”‚
â”‚    å¦‚æœæ˜¯æ–°æ’ä»¶ï¼š                   â”‚
â”‚    - plugin_count_++                â”‚
â”‚    - è®°å½•æ—¥å¿—                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

unregister_plugin("plugin_name")
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. åŠ å…¨å±€é”                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. registered_plugins_.erase()      â”‚
â”‚    å¦‚æœåˆ é™¤æˆåŠŸï¼š                   â”‚
â”‚    - plugin_count_--                â”‚
â”‚    - è®°å½•æ—¥å¿—                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æ£€æŸ¥ plugin_count_               â”‚
â”‚    if (plugin_count_ == 0) {        â”‚
â”‚      // æ‰€æœ‰æ’ä»¶éƒ½å·²å¸è½½             â”‚
â”‚      // ä½†ä¸é”€æ¯JVM (è®¾è®¡å†³ç­–)      â”‚
â”‚      è®°å½•æ—¥å¿—ï¼š"No plugins using JVM"â”‚
â”‚    }                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. GlobalThreadManager - çº¿ç¨‹çº§JNIç¯å¢ƒç®¡ç†

**èŒè´£**ï¼š
- ä¸ºæ¯ä¸ªçº¿ç¨‹é™„ç€/åˆ†ç¦»JVM
- ç»´æŠ¤å…¨å±€çº¿ç¨‹å¼•ç”¨è®¡æ•°
- è·Ÿè¸ªæ¯ä¸ªçº¿ç¨‹è¢«å“ªäº›æ’ä»¶ä½¿ç”¨
- ç¡®ä¿çº¿ç¨‹åªåœ¨æ‰€æœ‰æ’ä»¶éƒ½ä¸å†ä½¿ç”¨æ—¶æ‰åˆ†ç¦»

**å…³é”®æ•°æ®ç»“æ„**ï¼š
```cpp
class GlobalThreadManager {
private:
    static std::mutex thread_mutex_;    // çº¿ç¨‹æ“ä½œé”
    
    // å…¨å±€çº¿ç¨‹å¼•ç”¨è®¡æ•°ï¼šè®°å½•æ¯ä¸ªçº¿ç¨‹è¢«å¤šå°‘ä¸ªæ’ä»¶ä½¿ç”¨
    static std::unordered_map<std::thread::id, int> global_thread_ref_count_;
    
    // ç”±æœ¬ç®¡ç†å™¨é™„ç€çš„çº¿ç¨‹é›†åˆ
    static std::unordered_set<std::thread::id> attached_threads_;
    
    // çº¿ç¨‹-æ’ä»¶æ˜ å°„ï¼šè®°å½•æ¯ä¸ªçº¿ç¨‹è¢«å“ªäº›æ’ä»¶ä½¿ç”¨
    static std::unordered_map<std::thread::id, std::unordered_set<std::string>> thread_plugin_map_;
};
```

**å·¥ä½œæµç¨‹**ï¼š

#### 2.1 è·å–JNIç¯å¢ƒæµç¨‹

```
æ’ä»¶Aè°ƒç”¨ acquire_jni_env_for_plugin(jvm, "plugin_a")
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. åŠ çº¿ç¨‹é” (thread_mutex_)             â”‚
â”‚ 2. è·å–å½“å‰çº¿ç¨‹ID                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. è°ƒç”¨ jvm->GetEnv(&env, JNI_VERSION)  â”‚
â”‚    æ£€æŸ¥çº¿ç¨‹æ˜¯å¦å·²é™„ç€                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ è¿”å› JNI_OK?   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“æ˜¯              â†“å¦(JNI_EDETACHED)
      â†“                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4a. çº¿ç¨‹å·²é™„ç€â”‚  â”‚ 4b. çº¿ç¨‹æœªé™„ç€           â”‚
â”‚ å¢åŠ å¼•ç”¨è®¡æ•°  â”‚  â”‚ AttachCurrentThread()    â”‚
â”‚ ref_count++   â”‚  â”‚ æˆåŠŸåï¼š                 â”‚
â”‚               â”‚  â”‚ - attached_threads_.insert()â”‚
â”‚               â”‚  â”‚ - ref_count = 1          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. æ›´æ–°çº¿ç¨‹-æ’ä»¶æ˜ å°„                     â”‚
â”‚    thread_plugin_map_[tid].insert("plugin_a")â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. è®°å½•æ—¥å¿—                              â”‚
â”‚    "Thread %p attached, ref count: %d"   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
è¿”å› env

å¤šä¸ªæ’ä»¶åœ¨åŒä¸€çº¿ç¨‹ä¸­ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Thread-1:                               â”‚
â”‚ - plugin_aè°ƒç”¨ â†’ ref_count: 0â†’1        â”‚
â”‚ - plugin_bè°ƒç”¨ â†’ ref_count: 1â†’2        â”‚
â”‚ - plugin_cè°ƒç”¨ â†’ ref_count: 2â†’3        â”‚
â”‚                                         â”‚
â”‚ thread_plugin_map_[Thread-1] =          â”‚
â”‚   {"plugin_a", "plugin_b", "plugin_c"}  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.2 é‡Šæ”¾JNIç¯å¢ƒæµç¨‹

```
æ’ä»¶Aè°ƒç”¨ release_jni_env_for_plugin(jvm, "plugin_a")
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. åŠ çº¿ç¨‹é”                              â”‚
â”‚ 2. è·å–å½“å‰çº¿ç¨‹ID                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æŸ¥æ‰¾ global_thread_ref_count_[tid]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ æ‰¾åˆ°äº†ï¼Ÿ  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“æ˜¯          â†“å¦
      â†“            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4a. å¤„ç†  â”‚  â”‚ 4b. è®°å½•WARNINGâ”‚
â”‚          â”‚  â”‚ "Thread not    â”‚
â”‚          â”‚  â”‚  found in ref  â”‚
â”‚          â”‚  â”‚  count"        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. å‡å°‘å¼•ç”¨è®¡æ•°                          â”‚
â”‚    ref_count--                           â”‚
â”‚    thread_plugin_map_[tid].erase("plugin_a")â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. æ£€æŸ¥å¼•ç”¨è®¡æ•°                          â”‚
â”‚    if (ref_count <= 0) {                 â”‚
â”‚      // æ‰€æœ‰æ’ä»¶éƒ½å·²é‡Šæ”¾                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. åˆ†ç¦»çº¿ç¨‹                              â”‚
â”‚    if (attached_threads_.count(tid) > 0) {â”‚
â”‚      jvm->DetachCurrentThread();         â”‚
â”‚      attached_threads_.erase(tid);       â”‚
â”‚    }                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. æ¸…ç†æ˜ å°„                              â”‚
â”‚    global_thread_ref_count_.erase(tid);  â”‚
â”‚    thread_plugin_map_.erase(tid);        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¤ºä¾‹åœºæ™¯ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Thread-1 (åˆå§‹ ref_count = 3):          â”‚
â”‚                                         â”‚
â”‚ plugin_aå®Œæˆ â†’ ref_count: 3â†’2          â”‚
â”‚   ä¸åˆ†ç¦»ï¼Œplugin_bå’Œplugin_cè¿˜åœ¨ä½¿ç”¨    â”‚
â”‚                                         â”‚
â”‚ plugin_bå®Œæˆ â†’ ref_count: 2â†’1          â”‚
â”‚   ä¸åˆ†ç¦»ï¼Œplugin_cè¿˜åœ¨ä½¿ç”¨              â”‚
â”‚                                         â”‚
â”‚ plugin_cå®Œæˆ â†’ ref_count: 1â†’0          â”‚
â”‚   âœ… ç°åœ¨åˆ†ç¦»çº¿ç¨‹ï¼Œæ‰€æœ‰æ’ä»¶éƒ½å·²å®Œæˆ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. ScopedJNIEnvironment - RAIIå°è£…

**èŒè´£**ï¼š
- æä¾›RAIIé£æ ¼çš„JNIç¯å¢ƒç®¡ç†
- æ„é€ æ—¶è‡ªåŠ¨è·å–JNIç¯å¢ƒ
- ææ„æ—¶è‡ªåŠ¨é‡Šæ”¾JNIç¯å¢ƒ
- ç¡®ä¿å¼‚å¸¸å®‰å…¨

**ç±»å®šä¹‰**ï¼š
```cpp
class ScopedJNIEnvironment {
private:
    JNIEnv* env_;
    std::string plugin_name_;
    bool is_valid_;

public:
    // æ„é€ å‡½æ•°ï¼šè‡ªåŠ¨è·å–JNIç¯å¢ƒ
    ScopedJNIEnvironment(const std::string& plugin_name, 
                        const std::string& classpath = "",
                        size_t max_heap_mb = 512,
                        size_t init_heap_mb = 128);
    
    // ææ„å‡½æ•°ï¼šè‡ªåŠ¨é‡Šæ”¾JNIç¯å¢ƒ
    ~ScopedJNIEnvironment();
    
    // è·å–JNIç¯å¢ƒæŒ‡é’ˆ
    JNIEnv* get() const { return env_; }
    
    // æ£€æŸ¥æ˜¯å¦æœ‰æ•ˆ
    operator bool() const { return is_valid_; }
};
```

**ä½¿ç”¨æ–¹å¼**ï¼š
```cpp
int SimplifiedJNIBridge::segment(const std::string& text, 
                                 std::vector<std::string>& tokens) {
    // 1. åˆ›å»ºä½œç”¨åŸŸJNIç¯å¢ƒï¼ˆæ„é€ æ—¶è‡ªåŠ¨è·å–ï¼‰
    ScopedJNIEnvironment jni_env("experimental_japanese");
    
    if (!jni_env) {
        // è·å–å¤±è´¥
        return OBP_PLUGIN_ERROR;
    }
    
    // 2. ä½¿ç”¨JNIç¯å¢ƒè¿›è¡Œä¸šåŠ¡é€»è¾‘
    JNIEnv* env = jni_env.get();
    
    try {
        // ä¸šåŠ¡é€»è¾‘...
        jstring jtext = env->NewStringUTF(text.c_str());
        jobjectArray result = (jobjectArray)env->CallObjectMethod(...);
        // ...
        
    } catch (...) {
        // å³ä½¿æŠ›å‡ºå¼‚å¸¸ï¼Œææ„å‡½æ•°ä¹Ÿä¼šè¢«è°ƒç”¨
        // JNIç¯å¢ƒä¼šè¢«æ­£ç¡®é‡Šæ”¾
        return OBP_PLUGIN_ERROR;
    }
    
    return OBP_SUCCESS;
    
    // 3. å‡½æ•°ç»“æŸï¼Œjni_envææ„ï¼Œè‡ªåŠ¨é‡Šæ”¾JNIç¯å¢ƒ
    //    - å‡å°‘çº¿ç¨‹å¼•ç”¨è®¡æ•°
    //    - å¦‚æœref_count==0ï¼Œåˆ†ç¦»çº¿ç¨‹
}
```

**RAIIä¼˜åŠ¿**ï¼š
```
ä¼ ç»Ÿæ–¹å¼ï¼ˆæ‰‹åŠ¨ç®¡ç†ï¼‰ï¼š
    acquire_jni_env()
    try {
        // ä¸šåŠ¡é€»è¾‘
        if (error) {
            release_jni_env();  // å®¹æ˜“é—æ¼
            return;
        }
        // ...
    } catch (...) {
        release_jni_env();  // å¿…é¡»åœ¨æ¯ä¸ªå¼‚å¸¸è·¯å¾„è°ƒç”¨
        throw;
    }
    release_jni_env();

RAIIæ–¹å¼ï¼ˆè‡ªåŠ¨ç®¡ç†ï¼‰ï¼š
    ScopedJNIEnvironment env("plugin");
    // ä¸šåŠ¡é€»è¾‘
    // ä»»ä½•è¿”å›è·¯å¾„æˆ–å¼‚å¸¸ï¼Œéƒ½ä¼šè‡ªåŠ¨é‡Šæ”¾
    âœ… ç®€æ´ã€å®‰å…¨ã€ä¸ä¼šé—æ¼
```

## ğŸ”„ å®Œæ•´è°ƒç”¨æµç¨‹ç¤ºä¾‹

### åœºæ™¯ï¼š3ä¸ªæ’ä»¶åœ¨åŒä¸€çº¿ç¨‹ä¸­å¤„ç†æ–‡æœ¬

```
æ—¶åˆ» T0: ç³»ç»Ÿå¯åŠ¨
â”œâ”€ æ²¡æœ‰JVM
â”œâ”€ æ²¡æœ‰é™„ç€çš„çº¿ç¨‹
â””â”€ plugin_count = 0

æ—¶åˆ» T1: åŠ è½½ experimental_japanese_ftparser
â”œâ”€ ObserveråŠ è½½ .so
â”œâ”€ è°ƒç”¨ plugin_init_experimental_jp()
â”‚   â””â”€ æ³¨å†ŒFTParseræ¥å£å‡½æ•°
â””â”€ æ’ä»¶ç­‰å¾…ä½¿ç”¨

æ—¶åˆ» T2: åˆ›å»ºfulltextç´¢å¼•
â”œâ”€ Observerè°ƒç”¨ experimental_japanese_ftparser_init()
â”‚   â””â”€ SimplifiedJNIBridgeManager::initialize()
â”‚       â”œâ”€ GlobalJVMManager::get_or_create_jvm()
â”‚       â”‚   â”œâ”€ åŠ å…¨å±€é”
â”‚       â”‚   â”œâ”€ shared_jvm_ == nullptr
â”‚       â”‚   â”œâ”€ JNI_CreateJavaVM()  âœ… åˆ›å»ºJVM
â”‚       â”‚   â””â”€ è®°å½•é…ç½®
â”‚       â””â”€ GlobalJVMManager::register_plugin("experimental_japanese")
â”‚           â””â”€ plugin_count: 0â†’1
â””â”€ è¿”å› OBP_SUCCESS

æ—¶åˆ» T3: Thread-1 å¤„ç†ç¬¬ä¸€æ¡æ•°æ®ï¼ˆæ—¥è¯­ï¼‰
â”œâ”€ Observerè°ƒç”¨ experimental_japanese_ftparser_scan_begin()
â”‚   â”œâ”€ åˆ›å»º ExperimentalJapaneseParser å®ä¾‹
â”‚   â”œâ”€ SimplifiedJNIBridge::segment()
â”‚   â”‚   â”œâ”€ ScopedJNIEnvironment env("experimental_japanese")  // æ„é€ 
â”‚   â”‚   â”‚   â”œâ”€ GlobalJVMManager::get_jvm()  // è·å–å·²æœ‰JVM
â”‚   â”‚   â”‚   â””â”€ GlobalThreadManager::acquire_jni_env_for_plugin()
â”‚   â”‚   â”‚       â”œâ”€ åŠ çº¿ç¨‹é”
â”‚   â”‚   â”‚       â”œâ”€ jvm->GetEnv() â†’ JNI_EDETACHED
â”‚   â”‚   â”‚       â”œâ”€ jvm->AttachCurrentThread()  âœ… é™„ç€Thread-1
â”‚   â”‚   â”‚       â”œâ”€ global_thread_ref_count_[Thread-1] = 1
â”‚   â”‚   â”‚       â”œâ”€ attached_threads_.insert(Thread-1)
â”‚   â”‚   â”‚       â”œâ”€ thread_plugin_map_[Thread-1] = {"experimental_japanese"}
â”‚   â”‚   â”‚       â””â”€ è¿”å› env
â”‚   â”‚   â”œâ”€ è°ƒç”¨Javaåˆ†è¯æ–¹æ³•
â”‚   â”‚   â”‚   â””â”€ env->CallObjectMethod(segmenter, segment_method, jtext)
â”‚   â”‚   â””â”€ ~ScopedJNIEnvironment()  // ææ„
â”‚   â”‚       â””â”€ GlobalThreadManager::release_jni_env_for_plugin()
â”‚   â”‚           â”œâ”€ åŠ çº¿ç¨‹é”
â”‚   â”‚           â”œâ”€ global_thread_ref_count_[Thread-1]--  (1â†’0)
â”‚   â”‚           â”œâ”€ ref_count == 0
â”‚   â”‚           â”œâ”€ jvm->DetachCurrentThread()  âœ… åˆ†ç¦»Thread-1
â”‚   â”‚           â””â”€ æ¸…ç†æ˜ å°„
â”‚   â””â”€ è¿”å›åˆ†è¯ç»“æœ
â””â”€ Observerç»§ç»­è°ƒç”¨ next_token() è·å–æ¯ä¸ªtoken

å‡è®¾åŠ è½½æ›´å¤šæ’ä»¶ï¼ˆæœªæ¥æ‰©å±•ï¼‰ï¼š

æ—¶åˆ» T4: åŠ è½½ experimental_korean_ftparser
â”œâ”€ plugin_init_experimental_kr()
â”œâ”€ GlobalJVMManager::register_plugin("experimental_korean")
â”‚   â””â”€ plugin_count: 1â†’2
â””â”€ å¤ç”¨å·²æœ‰JVM âœ…

æ—¶åˆ» T5: Thread-2 åŒæ—¶å¤„ç†å¤šç§è¯­è¨€çš„æ•°æ®
â”œâ”€ japanese.scan_begin()
â”‚   â”œâ”€ acquire_jni_env("experimental_japanese")
â”‚   â”‚   â”œâ”€ AttachCurrentThread(Thread-2)
â”‚   â”‚   â”œâ”€ global_thread_ref_count_[Thread-2] = 1
â”‚   â”‚   â””â”€ thread_plugin_map_[Thread-2] = {"experimental_japanese"}
â”‚   â””â”€ å¤„ç†æ—¥è¯­æ–‡æœ¬
â”‚
â”œâ”€ korean.scan_begin()  (åŒä¸€ä¸ªThread-2)
â”‚   â”œâ”€ acquire_jni_env("experimental_korean")
â”‚   â”‚   â”œâ”€ GetEnv() â†’ JNI_OK  (çº¿ç¨‹å·²é™„ç€)
â”‚   â”‚   â”œâ”€ global_thread_ref_count_[Thread-2]++  (1â†’2)
â”‚   â”‚   â””â”€ thread_plugin_map_[Thread-2] = {"experimental_japanese", "experimental_korean"}
â”‚   â””â”€ å¤„ç†éŸ©è¯­æ–‡æœ¬
â”‚
â”œâ”€ japanese.scan_end()
â”‚   â””â”€ release_jni_env("experimental_japanese")
â”‚       â”œâ”€ global_thread_ref_count_[Thread-2]--  (2â†’1)
â”‚       â””â”€ ref_count > 0ï¼Œä¸åˆ†ç¦»çº¿ç¨‹ âœ…
â”‚
â””â”€ korean.scan_end()
    â””â”€ release_jni_env("experimental_korean")
        â”œâ”€ global_thread_ref_count_[Thread-2]--  (1â†’0)
        â”œâ”€ ref_count == 0
        â””â”€ DetachCurrentThread(Thread-2) âœ… ç°åœ¨æ‰åˆ†ç¦»

æ—¶åˆ» T6: å¸è½½æ‰€æœ‰æ’ä»¶
â”œâ”€ GlobalJVMManager::unregister_plugin("experimental_japanese")
â”‚   â””â”€ plugin_count: 2â†’1
â”œâ”€ GlobalJVMManager::unregister_plugin("experimental_korean")
â”‚   â””â”€ plugin_count: 1â†’0
â”œâ”€ plugin_count == 0
â””â”€ JVMä»ç„¶å­˜åœ¨ï¼ˆä¸é”€æ¯ï¼Œè®¾è®¡å†³ç­–ï¼‰
```

## ğŸ¯ å…³é”®è®¾è®¡å†³ç­–

### 1. JVMä¸ä¼šè¢«ä¸»åŠ¨é”€æ¯

**è®¾è®¡**ï¼š
```cpp
void GlobalJVMManager::unregister_plugin(const std::string& plugin_name) {
    // ...
    if (plugin_count_ == 0) {
        OBP_LOG_INFO("No plugins using JVM, but keeping it alive");
        // ä¸è°ƒç”¨ force_shutdown_jvm()
    }
}
```

**åŸå› **ï¼š
- JVMé”€æ¯åæ— æ³•é‡æ–°åˆ›å»ºï¼ˆJNIé™åˆ¶ï¼‰
- ä¿æŒJVMå­˜æ´»å…è®¸æ’ä»¶é‡æ–°åŠ è½½
- é¿å…é”€æ¯/é‡å»ºçš„å¤æ‚æ€§

### 2. çº¿ç¨‹çº§å¼•ç”¨è®¡æ•°

**è®¾è®¡**ï¼š
```cpp
static std::unordered_map<std::thread::id, int> global_thread_ref_count_;
```

**åŸå› **ï¼š
- å¤šä¸ªæ’ä»¶å¯èƒ½åœ¨åŒä¸€çº¿ç¨‹ä¸­è¿è¡Œ
- åªæœ‰å½“æ‰€æœ‰æ’ä»¶éƒ½ä¸å†ä½¿ç”¨çº¿ç¨‹æ—¶æ‰åˆ†ç¦»
- é¿å…è¿‡æ—©åˆ†ç¦»å¯¼è‡´çš„JNIé”™è¯¯

### 3. é…ç½®ä¸€è‡´æ€§éªŒè¯

**è®¾è®¡**ï¼š
```cpp
if (classpath != first_instance_classpath_) {
    OBP_LOG_WARN("JVM classpath mismatch...");
    // åªæ˜¯è­¦å‘Šï¼Œä¸é˜»æ­¢è¿è¡Œ
}
```

**åŸå› **ï¼š
- JVMåªèƒ½åˆ›å»ºä¸€æ¬¡ï¼Œåç»­æ’ä»¶å¿…é¡»ä½¿ç”¨ç›¸åŒé…ç½®
- ä¸ä¸€è‡´å¯èƒ½å¯¼è‡´åŠŸèƒ½é—®é¢˜ï¼Œä½†ä¸åº”å¯¼è‡´å´©æºƒ
- é€šè¿‡æ—¥å¿—å¸®åŠ©å¼€å‘è€…è¯Šæ–­é—®é¢˜

### 4. RAIIèµ„æºç®¡ç†

**è®¾è®¡**ï¼š
```cpp
class ScopedJNIEnvironment {
    ~ScopedJNIEnvironment() {
        // è‡ªåŠ¨é‡Šæ”¾
    }
};
```

**åŸå› **ï¼š
- ç¡®ä¿èµ„æºæ€»æ˜¯è¢«é‡Šæ”¾
- å¼‚å¸¸å®‰å…¨
- ç®€åŒ–æ’ä»¶ä»£ç 

## ğŸ“ˆ æ€§èƒ½ç‰¹æ€§

### 1. ä½å¼€é”€
- JVMåªåˆ›å»ºä¸€æ¬¡
- çº¿ç¨‹é™„ç€/åˆ†ç¦»ç”±å¼•ç”¨è®¡æ•°ä¼˜åŒ–
- å…¨å±€é”ç²’åº¦åˆç†

### 2. å¯æ‰©å±•
- æ”¯æŒä»»æ„æ•°é‡çš„æ’ä»¶
- æ’ä»¶é—´å®Œå…¨éš”ç¦»
- æ— éœ€ä¿®æ”¹å…¬å…±åº“

### 3. çº¿ç¨‹å®‰å…¨
- æ‰€æœ‰å…¨å±€çŠ¶æ€éƒ½æœ‰é”ä¿æŠ¤
- ä½¿ç”¨`std::lock_guard`ç¡®ä¿å¼‚å¸¸å®‰å…¨
- åŸå­å˜é‡ç”¨äºç®€å•è®¡æ•°å™¨

## ğŸ“ æ€»ç»“

å®éªŒæ’ä»¶çš„JVMå’ŒJNIç®¡ç†å®ç°äº†ï¼š

1. **âœ… å…¨å±€ç»Ÿä¸€ç®¡ç†**ï¼šå•ä¸€æƒå¨çš„JVMå’Œçº¿ç¨‹ç®¡ç†å™¨
2. **âœ… ç²¾ç¡®å¼•ç”¨è®¡æ•°**ï¼šçº¿ç¨‹çº§å¼•ç”¨è®¡æ•°ï¼Œé¿å…è¿‡æ—©åˆ†ç¦»
3. **âœ… å¼‚å¸¸å®‰å…¨**ï¼šRAIIç¡®ä¿èµ„æºæ€»æ˜¯è¢«æ­£ç¡®é‡Šæ”¾
4. **âœ… æ’ä»¶éš”ç¦»**ï¼šæ¯ä¸ªæ’ä»¶ç‹¬ç«‹å·¥ä½œï¼Œäº’ä¸å¹²æ‰°
5. **âœ… å¯æ‰©å±•æ€§**ï¼šæ–°æ’ä»¶åªéœ€é“¾æ¥å…¬å…±åº“ï¼Œæ— éœ€é‡å¤ä»£ç 

è¿™æ˜¯è§£å†³å¤šæ’ä»¶JNIèµ„æºç®¡ç†é—®é¢˜çš„**æœ€ä½³å®è·µ**ï¼
